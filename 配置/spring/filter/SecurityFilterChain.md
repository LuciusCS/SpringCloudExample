


### Spring 请求链路（包含 Spring Security FilterChain）


      ┌─────────────────────┐
      │   浏览器/客户端请求   │
      └─────────┬───────────┘
                ↓
┌─────────────────────────────┐
│ 普通 Filter (e.g. LogFilter) │
│  - 日志、编码、XSS 等         │
└─────────┬───────────────────┘
          ↓
┌─────────────────────────────┐
│ Spring Security FilterChain │   ← SecurityFilterChain 定义的一组安全 Filter
│  - 认证 (Authentication)    │
│  - 鉴权 (Authorization)     │
│  - 异常处理、CSRF、防重放等  │
   - 认证异常处理
└─────────┬───────────────────┘
          ↓
┌─────────────────────────────┐
│    DispatcherServlet (MVC)  │
└─────────┬───────────────────┘
          ↓
┌─────────────────────────────┐
│ Interceptor.preHandle       │
│  - 登录检查（业务级）         │
│  - 角色校验、日志   
   - 多租户拦截                 │
   - 操作日志、审计
└─────────┬───────────────────┘
          ↓
┌─────────────────────────────┐
│        Controller层         │
│   - 业务处理、调用Service    │
└─────────┬───────────────────┘
          ↓
┌─────────────────────────────┐
│ Interceptor.postHandle      │
│  - 数据加工、日志             │
└─────────┬───────────────────┘
          ↓
┌─────────────────────────────┐
│     视图解析 & 渲染          │
└─────────┬───────────────────┘
          ↓
┌─────────────────────────────┐
│ Interceptor.afterCompletion │
│  - 善后、资源清理、异常处理   │
└─────────┬───────────────────┘
          ↓
┌─────────────────────────────┐
│ Spring Security FilterChain │   ← 响应也会过一遍安全过滤器
│  - Header 设置               │
│  - SecurityContext 清理      │
└─────────┬───────────────────┘
          ↓
┌─────────────────────────────┐
│ 普通 Filter (响应方向)       │
│  - 压缩、统一Header          │
└─────────┬───────────────────┘
          ↓
┌─────────────────────┐
│   浏览器/客户端接收    │
└─────────────────────┘


### 关键点

1. SecurityFilterChain 属于 Filter 层，在进入 DispatcherServlet 前后都会生效。
2. 普通 Filter → 可以在 SecurityFilterChain 外面，也可以在它里面（取决于注册顺序）。
3. Interceptor → 只在 MVC 内部，永远在 SecurityFilterChain 之后才会执行。

### 订单系统

假设有接口：
```
POST /orders/{id}/cancel 
```

* Filter (SecurityFilterChain)：
  - 校验 JWT → 拿到用户 ID = 1001
  - 判断该接口需要角色 ROLE_USER → 当前用户有 → 放行
* Interceptor：
  - 拿到用户 ID = 1001
  - 从数据库查订单的 ownerId = 2002
  - 比较 → 不是本人订单 → 拦截，返回 403