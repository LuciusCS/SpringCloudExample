# 钉钉私聊消息配置指南

## 概述

钉钉私聊消息需要使用**企业内部应用**，而不是群机器人。这样可以直接向指定用户发送工作通知，而不是在群里 @ 他们。

## 配置步骤

### 1. 创建企业内部应用

1. 登录 [钉钉开放平台](https://open-dev.dingtalk.com/)
2. 进入"应用开发" → "企业内部开发" → "创建应用"
3. 填写应用信息：
   - 应用名称：例如"告警通知"
   - 应用描述：Prometheus 告警通知系统
   - 应用图标：上传一个图标

4. 创建完成后，获取以下信息：
   - **AppKey**（应用凭证）
   - **AppSecret**（应用密钥）
   - **AgentId**（应用 ID）

### 2. 配置应用权限

在应用详情页面，配置以下权限：

- **消息通知** → 工作通知权限
- **通讯录管理** → 成员信息读权限（用于通过手机号获取 UserID）

### 3. 获取用户 UserID

有两种方式获取用户的 UserID：

#### 方式 1: 通过手机号查询（推荐）

使用 `dingtalk_private.py` 中的 `get_userid_by_mobile()` 函数：

```python
from dingtalk_private import get_userid_by_mobile

# 通过手机号获取 UserID
userid = get_userid_by_mobile("18660277930")
print(f"UserID: {userid}")
```

#### 方式 2: 在钉钉管理后台查看

1. 登录钉钉管理后台
2. 进入"通讯录"
3. 点击员工姓名
4. 在详情页可以看到 UserID

### 4. 配置 dingtalk_private.py

编辑 `dingtalk_private.py` 文件：

```python
# ======= 钉钉企业内部应用配置 =======
APP_KEY = "dingxxxxxx"  # 替换为您的 AppKey
APP_SECRET = "xxxxxxxxxxxxxx"  # 替换为您的 AppSecret

# 接收告警的用户 UserID 列表
USER_IDS = [
    "manager001",  # 替换为实际的 UserID
    "admin002",    # 可以添加多个
]
```

### 5. 修改 main.py 添加私聊路由

编辑 `main.py`，添加钉钉私聊路由：

```python
import dingtalk_private

@app.route("/alert/dingtalk-private", methods=["POST"])
def alert_dingtalk_private():
    data = request.json
    result = dingtalk_private.handle_alert(data)
    return jsonify({"status": "ok", "result": result})
```

### 6. 更新 Alertmanager 配置

编辑 `alertmanager/config.yml`，添加钉钉私聊 webhook：

```yaml
receivers:
  - name: "all"
    webhook_configs:
      - url: "http://alert-webhook:5001/alert/wechat"
        send_resolved: true
      - url: "http://alert-webhook:5001/alert/dingtalk"  # 群消息
        send_resolved: true
      - url: "http://alert-webhook:5001/alert/dingtalk-private"  # 私聊消息（新增）
        send_resolved: true
      - url: "http://alert-webhook:5001/alert/sms"
        send_resolved: true
```

## 使用方式

### 同时使用群消息和私聊

- **群消息**（`dingtalk_webhook.py`）：发送到钉钉群，所有人可见
- **私聊消息**（`dingtalk_private.py`）：发送给指定用户，只有该用户可见

### 建议配置

```yaml
# 方案 1: 所有告警都发送群消息和私聊
receivers:
  - name: "all"
    webhook_configs:
      - url: "http://alert-webhook:5001/alert/dingtalk"  # 群通知
      - url: "http://alert-webhook:5001/alert/dingtalk-private"  # 私聊通知

# 方案 2: Critical 告警发私聊，Warning 告警发群消息
route:
  receiver: "default"
  routes:
    - match:
        severity: critical
      receiver: "critical-alerts"
    - match:
        severity: warning
      receiver: "warning-alerts"

receivers:
  - name: "default"
    webhook_configs: []
  
  - name: "critical-alerts"
    webhook_configs:
      - url: "http://alert-webhook:5001/alert/dingtalk-private"  # Critical 私聊
      - url: "http://alert-webhook:5001/alert/sms"  # Critical 发短信
  
  - name: "warning-alerts"
    webhook_configs:
      - url: "http://alert-webhook:5001/alert/dingtalk"  # Warning 群消息
```

## 测试

### 1. 获取 UserID

```bash
# 进入容器
docker exec -it alert-webhook python3

# 在 Python 中测试
>>> from dingtalk_private import get_userid_by_mobile
>>> userid = get_userid_by_mobile("18660277930")
>>> print(userid)
```

### 2. 测试发送

```bash
curl -X POST http://localhost:5001/alert/dingtalk-private \
  -H "Content-Type: application/json" \
  -d '{
    "alerts": [{
      "labels": {
        "alertname": "TestAlert",
        "severity": "warning"
      },
      "annotations": {
        "description": "这是一条测试私聊消息"
      },
      "status": "firing",
      "startsAt": "2025-12-03T16:00:00Z"
    }]
  }'
```

## 消息效果

用户会在钉钉的"工作通知"中收到消息，而不是在群聊中：

```
【工作通知】

🔥 TestAlert - 告警中

告警类型: system
严重程度: 🟡 warning
实例: 192.168.1.100:9100
状态: 告警中
当前值: 85.3%
阈值: 80%
开始时间: 2025-12-03 16:00:00

详情: 实例 192.168.1.100:9100 CPU 使用率为 85.3%
```

## 注意事项

> [!IMPORTANT]
> - AgentId 需要在代码中替换为实际值（在钉钉开发者后台查看）
> - UserID 不是手机号，需要通过 API 查询或在后台查看
> - 工作通知会显示在用户的"工作"标签页中
> - 需要确保应用有"工作通知"权限

## 故障排查

### 问题 1: errcode 40014 - 不合法的 access_token

**原因**：AppKey 或 AppSecret 配置错误

**解决**：检查钉钉开发者后台的应用凭证

### 问题 2: errcode 60011 - 不存在的用户

**原因**：UserID 不正确

**解决**：使用 `get_userid_by_mobile()` 重新获取 UserID

### 问题 3: errcode 60020 - 应用无权限

**原因**：应用没有工作通知权限

**解决**：在钉钉开发者后台给应用添加权限

## 对比：群消息 vs 私聊消息

| 特性 | 群消息 (dingtalk_webhook) | 私聊消息 (dingtalk_private) |
|------|--------------------------|----------------------------|
| 配置方式 | 群机器人 Webhook | 企业内部应用 |
| 接收方式 | 钉钉群聊 | 工作通知 |
| 可见范围 | 群内所有人 | 仅指定用户 |
| @ 功能 | 支持 @ 群成员 | 不需要（直接私聊） |
| 配置复杂度 | 简单 | 中等 |
| 适用场景 | 团队协作、信息共享 | 个人通知、敏感信息 |
