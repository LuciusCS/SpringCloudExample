# 钉钉 @ 功能使用说明

## 配置方式

在 `dingtalk_webhook.py` 中有三种 @ 方式：

### 方式 1: @ 指定手机号的用户（推荐）

```python
AT_MOBILES = [
    "18660277930",  # 取消注释并填写手机号
    "13800138000",  # 可以添加多个
]
```

> **注意**：手机号必须是钉钉群成员的手机号

### 方式 2: @ 所有人

```python
AT_ALL = True  # 设置为 True 则 @ 所有人
```

> **警告**：频繁 @ 所有人可能会打扰群成员，建议仅在 critical 告警时使用

### 方式 3: 仅在 Critical 告警时 @（推荐）

```python
AT_ON_CRITICAL = True  # critical 级别的告警才 @ 配置的人员
```

## 配置示例

### 示例 1: 仅 Critical 告警 @ 指定人员

```python
AT_MOBILES = [
    "18660277930",
]
AT_ALL = False
AT_ON_CRITICAL = True  # 只有 critical 告警才会 @
```

**效果**：
- Warning 告警：正常发送，不 @
- Critical 告警：发送并 @ 18660277930

### 示例 2: 所有告警都 @ 指定人员

```python
AT_MOBILES = [
    "18660277930",
    "13800138000",
]
AT_ALL = False
AT_ON_CRITICAL = False  # 关闭 critical 专属策略
```

**效果**：
- 所有告警都会 @ 这两个手机号

### 示例 3: Critical 告警 @ 所有人

```python
AT_MOBILES = []
AT_ALL = True
AT_ON_CRITICAL = True
```

**效果**：
- Warning 告警：正常发送，不 @
- Critical 告警：发送并 @ 所有人

## 钉钉机器人设置

### 1. 获取群成员手机号

在钉钉群中，点击群成员头像可以查看手机号（需要对方设置为可见）。

### 2. 机器人权限

确保钉钉机器人有 @ 权限：
1. 进入钉钉群设置
2. 找到智能群助手 → 添加机器人
3. 选择自定义机器人
4. **勾选"允许机器人 @ 群成员"**
5. 复制 Webhook 地址和加签密钥

## 消息示例

### 带 @ 的消息效果

```
@18660277930

🔥 CriticalCPUUsage - 告警中

告警类型: system
严重程度: 🔴 critical
实例: 192.168.1.100:9100
状态: 告警中
当前值: 92.5%
阈值: 90%
开始时间: 2025-12-03 16:00:00

详情: 实例 192.168.1.100:9100 CPU 使用率为 92.5%，已超过 90% 阈值持续 2 分钟，请立即处理！
```

被 @ 的用户会收到钉钉通知。

## 测试

修改配置后，重启服务：

```bash
cd /develop/docker/monitor
docker compose restart alert-webhook
```

触发测试告警：

```bash
bash test_alerts.sh
```

检查钉钉群是否收到带 @ 的消息。

## 故障排查

### 问题 1: @ 没有生效

**检查**：
1. 手机号是否正确（必须是群成员的手机号）
2. 机器人是否有 @ 权限
3. 查看日志：`docker logs alert-webhook`

### 问题 2: 提示"不在群中"

**原因**：填写的手机号不是钉钉群成员

**解决**：确保手机号对应的用户在钉钉群中

### 问题 3: @ 所有人失败

**原因**：机器人没有 @ 所有人的权限

**解决**：在钉钉群设置中给机器人授权
