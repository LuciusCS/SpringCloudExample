

## 为什么 @OneToOne(fetch = FetchType.LAZY) 没有懒加载？
JPA 的 @OneToOne 默认被 强制加载（EAGER），即便你显式写了 fetch = FetchType.LAZY，很多时候它也不起作用，原因如下：

1. JPA 实现限制（Hibernate）

Hibernate 实际上对 @OneToOne 的懒加载支持是有限的。要实现延迟加载，它必须通过字节码增强（bytecode enhancement）或其他代理机制，而不是仅仅靠 fetch = FetchType.LAZY。

2. 调试工具或日志行为

即使你设置了懒加载，在调试中查看对象属性（比如在 IDEA 的变量窗口或日志中），IDE 会触发 toString() 或 getter，从而强制初始化子对象，看起来像是“懒加载失效”。

✅ 正确认知与解决方式
✅ 方法 1：使用 @OneToOne 的懒加载增强

Hibernate 要求 @OneToOne(fetch = LAZY) 配合字节码增强才真正生效。

如果你没有启用 bytecode enhancement，那么你可以改用 @OneToMany + @ManyToOne(unique = true) 来替代 @OneToOne（底层其实是一样的）：

// AlarmChannelPO.java
@OneToMany(mappedBy = "alarmChannelPO", fetch = FetchType.LAZY)
private List<AlarmChannelDingDingPO> dingDingPOS;

// AlarmChannelDingDingPO.java
@ManyToOne(fetch = FetchType.LAZY)
@JoinColumn(name = "alarm_channel_id", referencedColumnName = "id", foreignKey = @ForeignKey(ConstraintMode.NO_CONSTRAINT))
private AlarmChannelPO alarmChannelPO;
然后在逻辑上你仍然保证是一对一（比如数据库唯一约束 + 代码控制只关联一个对象）。

✅ 方法 2：使用 DTO 转换避免递归加载

你已经在使用 DTO，可以进一步优化：

@Transactional(readOnly = true)
@Override
public Page<AlarmChannelDTO> getPage(@NonNull Pageable pageable) {
if (pageable.getSort().isUnsorted()) {
pageable = PageRequest.of(pageable.getPageNumber(), pageable.getPageSize(), AlarmChannelPO.DEFAULT_SORT);
}

    Page<AlarmChannelPO> page = alarmChannelDao.findAll(pageable);

    return page.map(po -> {
        AlarmChannelDTO dto = new AlarmChannelDTO();
        dto.setId(po.getId());
        dto.setChannelType(po.getChannelType());
        dto.setChannelName(po.getChannelName());
        // 不设置 po.getDingDingPO()，就不会触发懒加载
        return dto;
    });
}
只要你不访问 po.getDingDingPO()，懒加载就不会发生，即便调试窗口显示它有值，那可能是因为你点击展开了。

✅ 方法 3：使用 @JsonIgnore 或 DTO 限制序列化递归

如果你用的是 @RestController 直接返回 JSON，那么 Jackson 会序列化实体，导致懒加载自动发生。

解决：

@JsonIgnore // 在 AlarmChannelPO 的字段上
private AlarmChannelDingDingPO dingDingPO;
或者 DTO 替代。

🧠 总结
方式	是否推荐	说明
使用 @OneToOne(fetch = LAZY)	❌不推荐	Hibernate 中往往无效，除非启用字节码增强
使用 DTO + 控制访问字段	✅推荐	最通用方式，避免实体被懒加载
用 @OneToMany + @ManyToOne(unique=true) 代替	✅推荐	避免 @OneToOne 限制，懒加载有效
在 JSON 序列化中使用 @JsonIgnore	✅推荐	防止懒加载字段被序列化触发加载
