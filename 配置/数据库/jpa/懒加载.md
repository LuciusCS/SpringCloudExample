

## ä¸ºä»€ä¹ˆ @OneToOne(fetch = FetchType.LAZY) æ²¡æœ‰æ‡’åŠ è½½ï¼Ÿ
JPA çš„ @OneToOne é»˜è®¤è¢« å¼ºåˆ¶åŠ è½½ï¼ˆEAGERï¼‰ï¼Œå³ä¾¿ä½ æ˜¾å¼å†™äº† fetch = FetchType.LAZYï¼Œå¾ˆå¤šæ—¶å€™å®ƒä¹Ÿä¸èµ·ä½œç”¨ï¼ŒåŸå› å¦‚ä¸‹ï¼š

1. JPA å®ç°é™åˆ¶ï¼ˆHibernateï¼‰

Hibernate å®é™…ä¸Šå¯¹ @OneToOne çš„æ‡’åŠ è½½æ”¯æŒæ˜¯æœ‰é™çš„ã€‚è¦å®ç°å»¶è¿ŸåŠ è½½ï¼Œå®ƒå¿…é¡»é€šè¿‡å­—èŠ‚ç å¢å¼ºï¼ˆbytecode enhancementï¼‰æˆ–å…¶ä»–ä»£ç†æœºåˆ¶ï¼Œè€Œä¸æ˜¯ä»…ä»…é  fetch = FetchType.LAZYã€‚

2. è°ƒè¯•å·¥å…·æˆ–æ—¥å¿—è¡Œä¸º

å³ä½¿ä½ è®¾ç½®äº†æ‡’åŠ è½½ï¼Œåœ¨è°ƒè¯•ä¸­æŸ¥çœ‹å¯¹è±¡å±æ€§ï¼ˆæ¯”å¦‚åœ¨ IDEA çš„å˜é‡çª—å£æˆ–æ—¥å¿—ä¸­ï¼‰ï¼ŒIDE ä¼šè§¦å‘ toString() æˆ– getterï¼Œä»è€Œå¼ºåˆ¶åˆå§‹åŒ–å­å¯¹è±¡ï¼Œçœ‹èµ·æ¥åƒæ˜¯â€œæ‡’åŠ è½½å¤±æ•ˆâ€ã€‚

âœ… æ­£ç¡®è®¤çŸ¥ä¸è§£å†³æ–¹å¼
âœ… æ–¹æ³• 1ï¼šä½¿ç”¨ @OneToOne çš„æ‡’åŠ è½½å¢å¼º

Hibernate è¦æ±‚ @OneToOne(fetch = LAZY) é…åˆå­—èŠ‚ç å¢å¼ºæ‰çœŸæ­£ç”Ÿæ•ˆã€‚

å¦‚æœä½ æ²¡æœ‰å¯ç”¨ bytecode enhancementï¼Œé‚£ä¹ˆä½ å¯ä»¥æ”¹ç”¨ @OneToMany + @ManyToOne(unique = true) æ¥æ›¿ä»£ @OneToOneï¼ˆåº•å±‚å…¶å®æ˜¯ä¸€æ ·çš„ï¼‰ï¼š

// AlarmChannelPO.java
@OneToMany(mappedBy = "alarmChannelPO", fetch = FetchType.LAZY)
private List<AlarmChannelDingDingPO> dingDingPOS;

// AlarmChannelDingDingPO.java
@ManyToOne(fetch = FetchType.LAZY)
@JoinColumn(name = "alarm_channel_id", referencedColumnName = "id", foreignKey = @ForeignKey(ConstraintMode.NO_CONSTRAINT))
private AlarmChannelPO alarmChannelPO;
ç„¶ååœ¨é€»è¾‘ä¸Šä½ ä»ç„¶ä¿è¯æ˜¯ä¸€å¯¹ä¸€ï¼ˆæ¯”å¦‚æ•°æ®åº“å”¯ä¸€çº¦æŸ + ä»£ç æ§åˆ¶åªå…³è”ä¸€ä¸ªå¯¹è±¡ï¼‰ã€‚

âœ… æ–¹æ³• 2ï¼šä½¿ç”¨ DTO è½¬æ¢é¿å…é€’å½’åŠ è½½

ä½ å·²ç»åœ¨ä½¿ç”¨ DTOï¼Œå¯ä»¥è¿›ä¸€æ­¥ä¼˜åŒ–ï¼š

@Transactional(readOnly = true)
@Override
public Page<AlarmChannelDTO> getPage(@NonNull Pageable pageable) {
if (pageable.getSort().isUnsorted()) {
pageable = PageRequest.of(pageable.getPageNumber(), pageable.getPageSize(), AlarmChannelPO.DEFAULT_SORT);
}

    Page<AlarmChannelPO> page = alarmChannelDao.findAll(pageable);

    return page.map(po -> {
        AlarmChannelDTO dto = new AlarmChannelDTO();
        dto.setId(po.getId());
        dto.setChannelType(po.getChannelType());
        dto.setChannelName(po.getChannelName());
        // ä¸è®¾ç½® po.getDingDingPO()ï¼Œå°±ä¸ä¼šè§¦å‘æ‡’åŠ è½½
        return dto;
    });
}
åªè¦ä½ ä¸è®¿é—® po.getDingDingPO()ï¼Œæ‡’åŠ è½½å°±ä¸ä¼šå‘ç”Ÿï¼Œå³ä¾¿è°ƒè¯•çª—å£æ˜¾ç¤ºå®ƒæœ‰å€¼ï¼Œé‚£å¯èƒ½æ˜¯å› ä¸ºä½ ç‚¹å‡»å±•å¼€äº†ã€‚

âœ… æ–¹æ³• 3ï¼šä½¿ç”¨ @JsonIgnore æˆ– DTO é™åˆ¶åºåˆ—åŒ–é€’å½’

å¦‚æœä½ ç”¨çš„æ˜¯ @RestController ç›´æ¥è¿”å› JSONï¼Œé‚£ä¹ˆ Jackson ä¼šåºåˆ—åŒ–å®ä½“ï¼Œå¯¼è‡´æ‡’åŠ è½½è‡ªåŠ¨å‘ç”Ÿã€‚

è§£å†³ï¼š

@JsonIgnore // åœ¨ AlarmChannelPO çš„å­—æ®µä¸Š
private AlarmChannelDingDingPO dingDingPO;
æˆ–è€… DTO æ›¿ä»£ã€‚

ğŸ§  æ€»ç»“
æ–¹å¼	æ˜¯å¦æ¨è	è¯´æ˜
ä½¿ç”¨ @OneToOne(fetch = LAZY)	âŒä¸æ¨è	Hibernate ä¸­å¾€å¾€æ— æ•ˆï¼Œé™¤éå¯ç”¨å­—èŠ‚ç å¢å¼º
ä½¿ç”¨ DTO + æ§åˆ¶è®¿é—®å­—æ®µ	âœ…æ¨è	æœ€é€šç”¨æ–¹å¼ï¼Œé¿å…å®ä½“è¢«æ‡’åŠ è½½
ç”¨ @OneToMany + @ManyToOne(unique=true) ä»£æ›¿	âœ…æ¨è	é¿å… @OneToOne é™åˆ¶ï¼Œæ‡’åŠ è½½æœ‰æ•ˆ
åœ¨ JSON åºåˆ—åŒ–ä¸­ä½¿ç”¨ @JsonIgnore	âœ…æ¨è	é˜²æ­¢æ‡’åŠ è½½å­—æ®µè¢«åºåˆ—åŒ–è§¦å‘åŠ è½½
