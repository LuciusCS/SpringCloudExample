


## 微服务全链路性能排查表


| 层级                             | 瓶颈表现                | 可能原因                                                     | 排查工具/方法                                                                                     | 测试方法                       |
| ------------------------------ | ------------------- | -------------------------------------------------------- | ------------------------------------------------------------------------------------------- | -------------------------- |
| **客户端 → 网络 → 微服务入口**           | 请求延迟高、丢包、连接超时       | 网络带宽不足、网络延迟高、负载均衡器队列或并发限制                                | `ping`, `traceroute`, `iperf`, 检查 LB 配置                                                     | 压测高并发请求，观察响应时间和丢包率         |
| **操作系统层（OS）**                  | 新连接慢、连接数达上限         | 文件描述符不足 (`ulimit -n`)、TCP 参数不合理、CPU/内存抢占                 | `ulimit -n`, `netstat -an`, `top`/`htop`, `vmstat`                                          | 调整 TCP 参数，模拟高连接数压测         |
| **应用服务器层（Tomcat/Netty/Nginx）** | 请求排队、响应延迟增加、部分请求被拒绝 | 线程池配置过小 (`maxThreads`)、队列满 (`acceptCount`)、数据库/外部服务连接池耗尽 | 查看应用日志、监控线程池使用情况                                                                            | 压测不同线程池配置下的 QPS/延迟，监控请求队列  |
| **JVM 层**                      | 响应变慢、吞吐下降、偶尔停顿      | 堆内存不足 → GC 频繁；堆过大 → GC 停顿；线程数过多 → 上下文切换成本高               | `jcmd <pid> GC.heap_info`, `jstat -gc`, `jcmd <pid> Thread.print`, VisualVM/Flight Recorder | 高并发压测，观察 GC 停顿、吞吐变化、线程数变化  |
| **业务逻辑 / 应用层**                 | CPU 高、处理慢、请求排队      | CPU 密集型计算、阻塞 I/O、锁竞争、缓存命中率低                              | `async-profiler`, YourKit, 日志分析                                                             | 压测关键业务逻辑，分析热点代码和锁等待        |
| **数据库层**                       | 响应慢、事务等待、锁竞争        | 连接数不足、慢查询、索引缺失、高并发写导致锁等待或死锁                              | `SHOW PROCESSLIST`, `pg_stat_activity`, 慢查询日志、数据库性能监控工具（PMM）                                | 模拟并发查询/写入，监控延迟、锁等待、吞吐量     |
| **外部依赖 / 第三方服务**               | 响应慢，微服务延迟增加         | 第三方 API 响应慢、消息队列/缓存服务性能不足、网络延迟                           | 链路追踪工具（Zipkin/Jaeger）、调用日志                                                                  | 单独压测外部依赖，设置超时/熔断策略，观察微服务响应 |
| **硬件层**                        | 系统整体吞吐下降、响应时间增加     | CPU 核心数不足、内存不足、磁盘 I/O 限制、网络带宽不足                          | `top`, `iostat`, `vmstat`, `sar`, `netstat`                                                 | 压测不同资源情况下性能变化，分析瓶颈影响       |



## 微服务全链路性能指标表

| 层级                       | 指标                               | 参考阈值/告警                                              | 排查/测试工具                                            | 说明                            |
| ------------------------ | -------------------------------- | ---------------------------------------------------- | -------------------------------------------------- | ----------------------------- |
| **客户端 → 网络 → 微服务入口**     | RTT、丢包率、带宽利用率                    | RTT > 100ms、丢包率 > 1%、带宽 > 80%                        | `ping`, `traceroute`, `iperf`, LB/Router监控         | 网络延迟高或丢包会直接影响吞吐量和响应时间         |
| **操作系统层（OS）**            | 文件描述符使用率、TCP 连接数、CPU/内存利用率       | FD 使用率 > 80%、TCP 连接接近上限、CPU > 85%、内存 > 80%           | `ulimit -n`, `netstat -an`, `top`, `vmstat`        | 文件描述符限制或 CPU 内存耗尽会导致新连接慢或请求丢失 |
| **应用服务器层（Tomcat/Netty）** | 活跃线程数 / maxThreads、请求队列长度、连接池使用率 | 活跃线程 > 80% maxThreads、队列长度 > acceptCount、连接池使用 > 80% | JMX监控、应用日志、Prometheus/Grafana                      | 请求排队或拒绝服务通常由线程池或队列饱和引起        |
| **JVM 层**                | 堆使用率、GC停顿时间、线程数、CPU 使用率          | 堆使用率 > 80%、GC暂停 > 100ms、线程数 > CPU核数\*2、CPU > 85%     | `jstat`, `jcmd`, VisualVM, Flight Recorder         | GC频繁或线程过多会直接影响吞吐和响应时间         |
| **业务逻辑 / 应用层**           | 平均响应时间、CPU占用、锁等待时间、缓存命中率         | 平均响应时间 > SLA阈值、CPU > 85%、锁等待占比 > 10%、缓存命中率 < 80%     | APM工具（SkyWalking/Pinpoint/NewRelic）、async-profiler | CPU或阻塞严重时，吞吐量下降，响应时间增加        |
| **数据库层**                 | QPS、慢查询数、连接池使用率、锁等待/死锁数、TPS      | 慢查询 > 1% 总查询数、连接池使用 > 80%、锁等待时间 > 50ms               | 数据库监控（PMM, pg\_stat\_statements, SHOW PROCESSLIST） | 数据库成为瓶颈时，请求响应增加、吞吐下降          |
| **外部依赖 / 第三方服务**         | 平均响应时间、错误率、超时率                   | 响应时间 > SLA阈值、错误率 > 1%、超时率 > 1%                       | 链路追踪（Zipkin/Jaeger）、日志分析、压测                        | 外部服务慢或不稳定会直接拖慢微服务响应           |
| **硬件层**                  | CPU利用率、内存利用率、磁盘IOPS、磁盘延迟、网络带宽利用率 | CPU > 85%、内存 > 80%、磁盘IOPS饱和、磁盘延迟 > 10ms、网络带宽 > 80%   | `top`, `iostat`, `vmstat`, `sar`, `netstat`        | 硬件瓶颈会限制整体吞吐量和并发数              |
